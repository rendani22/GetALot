<div class="scan-package-container">
  <header class="page-header">
    <button class="back-btn" routerLink="/dashboard">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
      </svg>
    </button>
    <h1>Scan Package</h1>
  </header>

  <main class="content">
    <!-- Loading State -->
    @if (isLoading()) {
      <div class="loading-card">
        <div class="spinner"></div>
        <p>Looking up package...</p>
      </div>
    }

    <!-- Error State (with no package) -->
    @else if (errorMessage() && !scannedPackage()) {
      <div class="error-card">
        <div class="error-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
          </svg>
        </div>
        <p class="error-message">{{ errorMessage() }}</p>
        <button class="btn btn-primary" (click)="scanAnother()">
          Try Again
        </button>
      </div>
    }

    <!-- Scanner -->
    @else if (showScanner()) {
      <div class="scanner-card">
        <div class="scanner-intro">
          <h2>Scan Package QR Code</h2>
          <p>Point your camera at the QR code on the package label to retrieve package details.</p>
        </div>

        <app-qr-scanner
          (scanned)="onQrScanned($event)"
        />
      </div>
    }

    <!-- Package Found -->
    @else if (scannedPackage()) {
      <div class="result-card" [class.error]="errorMessage()">
        <!-- Status Icon -->
        <div class="status-icon" [class.success]="!errorMessage()" [class.warning]="errorMessage()">
          @if (errorMessage()) {
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
            </svg>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          }
        </div>

        <!-- Error Message -->
        @if (errorMessage()) {
          <div class="result-error">
            <p>{{ errorMessage() }}</p>
          </div>
        } @else {
          <h2>Package Found</h2>
        }

        <!-- Package Reference -->
        <div class="reference-display">
          <span class="label">Reference Number</span>
          <span class="reference">{{ scannedPackage()!.reference }}</span>
        </div>

        <!-- Package Details -->
        <div class="package-details">
          <div class="detail-row">
            <span class="label">Receiver</span>
            <span class="value">{{ scannedPackage()!.receiver_email }}</span>
          </div>
          @if (scannedPackage()!.notes) {
            <div class="detail-row">
              <span class="label">Notes</span>
              <span class="value">{{ scannedPackage()!.notes }}</span>
            </div>
          }
          <div class="detail-row">
            <span class="label">Status</span>
            <span class="status-badge" [style.background-color]="statusConfig[scannedPackage()!.status].color">
              {{ statusConfig[scannedPackage()!.status].label }}
            </span>
          </div>
          <div class="detail-row">
            <span class="label">Created</span>
            <span class="value">{{ formatDate(scannedPackage()!.created_at) }}</span>
          </div>
          @if (scannedPackage()!.collected_at) {
            <div class="detail-row">
              <span class="label">Collected</span>
              <span class="value">{{ formatDate(scannedPackage()!.collected_at) }}</span>
            </div>
          }
        </div>

        <!-- Actions -->
        <div class="action-buttons">
          @if (!errorMessage() && scannedPackage()!.status !== 'collected' && scannedPackage()!.status !== 'returned') {
            <button class="btn btn-primary btn-large" (click)="proceedToCollection(scannedPackage()!)">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Proceed to Collection
            </button>
          }
          <button class="btn btn-secondary" (click)="scanAnother()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="18" height="18">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0113.5 9.375v-4.5z" />
            </svg>
            Scan Another
          </button>
        </div>
      </div>
    }
  </main>
</div>

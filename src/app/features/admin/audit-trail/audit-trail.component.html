<div class="audit-trail-container">
  <header class="page-header">
    <button class="back-btn" (click)="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
      </svg>
    </button>
    <div class="header-content">
      <h1>Audit Trail</h1>
      <span class="record-count">{{ totalCount() }} records</span>
    </div>
    <div class="header-actions">
      <button
        class="export-btn"
        (click)="exportToCsv()"
        [disabled]="isExporting() || isLoading() || totalCount() === 0"
        title="Export to CSV"
      >
        @if (isExporting()) {
          <span class="spinner-small"></span>
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
          </svg>
        }
        <span class="export-text">CSV</span>
      </button>
      <button class="filter-toggle-btn" (click)="toggleFilters()" [class.active]="showFilters() || hasActiveFilters()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" />
        </svg>
        @if (hasActiveFilters()) {
          <span class="filter-badge"></span>
        }
      </button>
    </div>
  </header>

  <!-- Filters Panel -->
  @if (showFilters()) {
    <div class="filters-panel">
      <div class="filters-grid">
        <div class="filter-group">
          <label for="filterPackageRef">Package/POD Reference</label>
          <input
            type="text"
            id="filterPackageRef"
            [(ngModel)]="filterPackageRef"
            placeholder="Search by reference..."
          />
        </div>

        <div class="filter-group">
          <label for="filterStaff">Staff Member</label>
          <select id="filterStaff" [(ngModel)]="filterStaffId">
            <option value="">All Staff</option>
            @for (staff of staffList(); track staff.id) {
              <option [value]="staff.user_id">{{ staff.full_name }}</option>
            }
          </select>
        </div>

        <div class="filter-group">
          <label for="filterAction">Action Type</label>
          <select id="filterAction" [(ngModel)]="filterAction">
            <option value="">All Actions</option>
            @for (action of actionTypes(); track action) {
              <option [value]="action">{{ getActionConfig(action).label }}</option>
            }
          </select>
        </div>

        <div class="filter-group">
          <label for="filterDateFrom">Date From</label>
          <input
            type="date"
            id="filterDateFrom"
            [(ngModel)]="filterDateFrom"
          />
        </div>

        <div class="filter-group">
          <label for="filterDateTo">Date To</label>
          <input
            type="date"
            id="filterDateTo"
            [(ngModel)]="filterDateTo"
          />
        </div>
      </div>

      <div class="filters-actions">
        <button class="btn btn-secondary" (click)="clearFilters()" [disabled]="!hasActiveFilters()">
          Clear Filters
        </button>
        <button class="btn btn-primary" (click)="applyFilters()">
          Apply Filters
        </button>
      </div>
    </div>
  }

  <main class="content">
    <!-- Loading State -->
    @if (isLoading()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading audit logs...</p>
      </div>
    }

    <!-- Error State -->
    @else if (errorMessage()) {
      <div class="error-state">
        <div class="error-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
          </svg>
        </div>
        <p>{{ errorMessage() }}</p>
        <button class="btn btn-primary" (click)="loadAuditLogs()">
          Try Again
        </button>
      </div>
    }

    <!-- Empty State -->
    @else if (auditLogs().length === 0) {
      <div class="empty-state">
        <div class="empty-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
          </svg>
        </div>
        <h3>No audit logs found</h3>
        <p>{{ hasActiveFilters() ? 'Try adjusting your filters' : 'System activity will appear here' }}</p>
      </div>
    }

    <!-- Timeline View -->
    @else {
      <div class="timeline">
        @for (log of auditLogs(); track log.id) {
          <div class="timeline-item">
            <div class="timeline-marker" [style.background-color]="getActionConfig(log.action).color">
              <!-- Action Icon based on type -->
              @switch (getActionConfig(log.action).icon) {
                @case ('plus-circle') {
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                }
                @case ('check-circle') {
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                }
                @case ('lock-closed') {
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                  </svg>
                }
                @case ('qr-code') {
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5z" />
                  </svg>
                }
                @case ('camera') {
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                  </svg>
                }
                @case ('pencil-alt') {
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" />
                  </svg>
                }
                @case ('document-text') {
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                  </svg>
                }
                @case ('mail') {
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                  </svg>
                }
                @case ('download') {
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                  </svg>
                }
                @default {
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                  </svg>
                }
              }
            </div>

            <div class="timeline-content">
              <div class="timeline-header">
                <span class="action-label" [style.color]="getActionConfig(log.action).color">
                  {{ getActionConfig(log.action).label }}
                </span>
                <span class="timestamp" [title]="formatDate(log.created_at)">
                  {{ formatRelativeTime(log.created_at) }}
                </span>
              </div>

              <div class="timeline-body">
                <!-- Staff Info -->
                <div class="staff-info">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="14" height="14">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                  </svg>
                  <span>
                    {{ log.staff_profile?.full_name || log.metadata?.['performed_by_name'] || 'Unknown' }}
                    @if (log.staff_profile?.role || log.metadata?.['performed_by_role']) {
                      <span class="role-badge">{{ log.staff_profile?.role || log.metadata?.['performed_by_role'] }}</span>
                    }
                  </span>
                </div>

                <!-- Metadata -->
                @if (getMetadataDisplay(log).length > 0) {
                  <div class="metadata-list">
                    @for (item of getMetadataDisplay(log); track item) {
                      <span class="metadata-item">{{ item }}</span>
                    }
                  </div>
                }

                <!-- Entity Info -->
                <div class="entity-info">
                  <span class="entity-type">{{ log.entity_type }}</span>
                  <span class="entity-id" [title]="log.entity_id">{{ log.entity_id.substring(0, 8) }}...</span>
                </div>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Pagination -->
      @if (totalPages() > 1) {
        <div class="pagination">
          <button
            class="pagination-btn"
            (click)="goToPage(currentPage() - 1)"
            [disabled]="currentPage() === 1"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
            </svg>
            Previous
          </button>

          <span class="pagination-info">
            Page {{ currentPage() }} of {{ totalPages() }}
          </span>

          <button
            class="pagination-btn"
            (click)="goToPage(currentPage() + 1)"
            [disabled]="currentPage() === totalPages()"
          >
            Next
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
          </button>
        </div>
      }
    }
  </main>
</div>

<div class="location-management">
  <!-- Header -->
  <header class="page-header">
    <div class="header-left">
      <button class="back-btn" (click)="goBack()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" />
        </svg>
      </button>
      <h1>Delivery Locations</h1>
    </div>
    <button class="add-btn" (click)="openCreateModal()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
      </svg>
      Add Location
    </button>
  </header>

  <!-- Success/Error Messages -->
  @if (successMessage()) {
    <div class="alert alert-success">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
      </svg>
      {{ successMessage() }}
    </div>
  }

  @if (locationService.error$ | async; as error) {
    <div class="alert alert-error">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
      </svg>
      {{ error }}
    </div>
  }

  <!-- Location List -->
  <div class="location-list">
    @if (locationService.loading$ | async) {
      <div class="loading">
        <div class="spinner"></div>
        <span>Loading locations...</span>
      </div>
    } @else {
      @if (locationService.locations$ | async; as locations) {
        @if (locations.length === 0) {
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
            </svg>
            <p>No delivery locations yet</p>
            <button class="add-btn" (click)="openCreateModal()">Add First Location</button>
          </div>
        } @else {
          @for (location of locations; track location.id) {
            <div class="location-card" [class.inactive]="!location.is_active">
              <div class="location-info">
                <div class="avatar">
                  {{ getInitials(location) }}
                </div>
                <div class="details">
                  <h3>{{ location.name }}</h3>
                  <p class="address">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.096.446-.24.757-.433.62-.384 1.445-.966 2.274-1.765C15.302 14.988 17 12.493 17 9A7 7 0 103 9c0 3.492 1.698 5.988 3.355 7.584a13.731 13.731 0 002.273 1.765 11.842 11.842 0 00.976.544l.062.029.018.008.006.003zM10 11.25a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" clip-rule="evenodd" />
                    </svg>
                    {{ location.address }}
                  </p>
                  @if (location.google_maps_link) {
                    <button class="maps-link" (click)="openGoogleMaps(location.google_maps_link)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 17h-8.5A2.25 2.25 0 012 14.75v-8.5A2.25 2.25 0 014.25 4h5a.75.75 0 010 1.5h-5z" clip-rule="evenodd" />
                        <path fill-rule="evenodd" d="M6.194 12.753a.75.75 0 001.06.053L16.5 4.44v2.81a.75.75 0 001.5 0v-4.5a.75.75 0 00-.75-.75h-4.5a.75.75 0 000 1.5h2.553l-9.056 8.194a.75.75 0 00-.053 1.06z" clip-rule="evenodd" />
                      </svg>
                      Open in Google Maps
                    </button>
                  }
                </div>
              </div>
              <div class="location-meta">
                <div class="dates">
                  <div class="date-item">
                    <span class="date-label">Created:</span>
                    <span class="date-value">{{ formatDate(location.created_at) }}</span>
                  </div>
                  <div class="date-item">
                    <span class="date-label">Updated:</span>
                    <span class="date-value">{{ formatDate(location.updated_at) }}</span>
                  </div>
                </div>
                @if (!location.is_active) {
                  <span class="status-badge inactive">Inactive</span>
                }
              </div>
              <div class="location-actions">
                <button class="action-btn edit" (click)="openEditModal(location)" title="Edit">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" />
                    <path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" />
                  </svg>
                </button>
                <button
                  class="action-btn"
                  [class.activate]="!location.is_active"
                  [class.deactivate]="location.is_active"
                  (click)="toggleActive(location)"
                  [title]="location.is_active ? 'Deactivate' : 'Activate'"
                >
                  @if (location.is_active) {
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                    </svg>
                  } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" />
                    </svg>
                  }
                </button>
              </div>
            </div>
          }
        }
      }
    }
  </div>

  <!-- Create Modal -->
  @if (showCreateModal()) {
    <div class="modal-overlay" (click)="closeCreateModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Add Delivery Location</h2>
          <button class="close-btn" (click)="closeCreateModal()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>

        @if (errorMessage()) {
          <div class="modal-error">{{ errorMessage() }}</div>
        }

        <form [formGroup]="createForm" (ngSubmit)="createLocation()">
          <div class="form-group">
            <label for="create-name">Location Name *</label>
            <input
              id="create-name"
              type="text"
              formControlName="name"
              placeholder="e.g., Head Office, Warehouse A"
              [class.invalid]="isFieldInvalid(createForm, 'name')"
            />
            @if (isFieldInvalid(createForm, 'name')) {
              <span class="error">Location name is required (min 2 characters)</span>
            }
          </div>

          <div class="form-group">
            <label for="create-address">Address *</label>
            <textarea
              id="create-address"
              formControlName="address"
              placeholder="Enter the full address"
              rows="3"
              [class.invalid]="isFieldInvalid(createForm, 'address')"
            ></textarea>
            @if (isFieldInvalid(createForm, 'address')) {
              <span class="error">Address is required (min 5 characters)</span>
            }
          </div>

          <div class="form-group">
            <label for="create-google-maps">Google Maps Link (Optional)</label>
            <input
              id="create-google-maps"
              type="url"
              formControlName="google_maps_link"
              placeholder="https://maps.google.com/..."
            />
            <span class="field-hint">Paste the Google Maps share link for easy navigation</span>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="closeCreateModal()">Cancel</button>
            <button type="submit" class="btn-submit" [disabled]="isSubmitting()">
              @if (isSubmitting()) {
                <span class="spinner-small"></span>
                Creating...
              } @else {
                Create Location
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Edit Modal -->
  @if (showEditModal()) {
    <div class="modal-overlay" (click)="closeEditModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Edit Delivery Location</h2>
          <button class="close-btn" (click)="closeEditModal()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>

        @if (errorMessage()) {
          <div class="modal-error">{{ errorMessage() }}</div>
        }

        <form [formGroup]="editForm" (ngSubmit)="updateLocation()">
          <div class="form-group">
            <label for="edit-name">Location Name *</label>
            <input
              id="edit-name"
              type="text"
              formControlName="name"
              placeholder="e.g., Head Office, Warehouse A"
              [class.invalid]="isFieldInvalid(editForm, 'name')"
            />
            @if (isFieldInvalid(editForm, 'name')) {
              <span class="error">Location name is required (min 2 characters)</span>
            }
          </div>

          <div class="form-group">
            <label for="edit-address">Address *</label>
            <textarea
              id="edit-address"
              formControlName="address"
              placeholder="Enter the full address"
              rows="3"
              [class.invalid]="isFieldInvalid(editForm, 'address')"
            ></textarea>
            @if (isFieldInvalid(editForm, 'address')) {
              <span class="error">Address is required (min 5 characters)</span>
            }
          </div>

          <div class="form-group">
            <label for="edit-google-maps">Google Maps Link (Optional)</label>
            <input
              id="edit-google-maps"
              type="url"
              formControlName="google_maps_link"
              placeholder="https://maps.google.com/..."
            />
            <span class="field-hint">Paste the Google Maps share link for easy navigation</span>
          </div>

          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="is_active" />
              <span>Active</span>
            </label>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="closeEditModal()">Cancel</button>
            <button type="submit" class="btn-submit" [disabled]="isSubmitting()">
              @if (isSubmitting()) {
                <span class="spinner-small"></span>
                Updating...
              } @else {
                Update Location
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
